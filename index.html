<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idea Foundry - AI-Powered Idea Discovery</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: #374151; /* text-gray-700 */
            background-color: #F9FAFB; /* bg-gray-50 */
        }
        button {
            cursor: pointer;
            border: none;
            font-family: inherit;
        }
        button:disabled {
            cursor: not-allowed;
        }
        input {
            font-family: inherit;
        }
        a {
            color: inherit;
            text-decoration: inherit;
        }
        
        /* Utility Classes */
        .hidden {
            display: none !important;
        }
        .flex {
            display: flex;
        }
        .flex-1 {
            flex: 1;
        }
        .flex-col {
            flex-direction: column;
        }
        .flex-row-reverse {
            flex-direction: row-reverse;
        }
        .flex-wrap {
            flex-wrap: wrap;
        }
        .flex-shrink-0 {
            flex-shrink: 0;
        }
        .grid {
            display: grid;
        }
        .items-start {
            align-items: flex-start;
        }
        .items-center {
            align-items: center;
        }
        .justify-center {
            justify-content: center;
        }
        .justify-between {
            justify-content: space-between;
        }
        .space-x-2 > * + * {
            margin-left: 0.5rem;
        }
        .space-x-3 > * + * {
            margin-left: 0.75rem;
        }
        .space-x-4 > * + * {
            margin-left: 1rem;
        }
        .space-x-reverse > * + * {
            margin-right: 0.75rem;
            margin-left: 0;
        }
        .space-y-4 > * + * {
            margin-top: 1rem;
        }
        .gap-1 {
            gap: 0.25rem;
        }
        .gap-2 {
            gap: 0.5rem;
        }
        .gap-3 {
            gap: 0.75rem;
        }
        .gap-4 {
            gap: 1rem;
        }
        
        /* Layout */
        .container {
            width: 100%;
            margin-left: auto;
            margin-right: auto;
        }
        .max-w-md {
            max-width: 28rem;
        }
        .max-w-2xl {
            max-width: 42rem;
        }
        .max-w-3xl {
            max-width: 48rem;
        }
        .max-w-4xl {
            max-width: 56rem;
        }
        .max-w-6xl {
            max-width: 72rem;
        }
        .w-full {
            width: 100%;
        }
        .w-5 {
            width: 1.25rem;
        }
        .w-8 {
            width: 2rem;
        }
        .h-5 {
            height: 1.25rem;
        }
        .h-8 {
            height: 2rem;
        }
        .min-h-screen {
            min-height: 100vh;
        }
        
        /* Spacing */
        .p-2 {
            padding: 0.5rem;
        }
        .p-3 {
            padding: 0.75rem;
        }
        .p-4 {
            padding: 1rem;
        }
        .p-6 {
            padding: 1.5rem;
        }
        .p-8 {
            padding: 2rem;
        }
        .px-2 {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        .px-3 {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }
        .px-4 {
            padding-left: 1rem;
            padding-right: 1rem;
        }
        .px-6 {
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }
        .py-1 {
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
        }
        .py-2 {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
        .py-3 {
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }
        .py-4 {
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        .py-12 {
            padding-top: 3rem;
            padding-bottom: 3rem;
        }
        .m-4 {
            margin: 1rem;
        }
        .mx-4 {
            margin-left: 1rem;
            margin-right: 1rem;
        }
        .mt-1 {
            margin-top: 0.25rem;
        }
        .mt-2 {
            margin-top: 0.5rem;
        }
        .mt-4 {
            margin-top: 1rem;
        }
        .mb-2 {
            margin-bottom: 0.5rem;
        }
        .mb-3 {
            margin-bottom: 0.75rem;
        }
        .mb-4 {
            margin-bottom: 1rem;
        }
        .mb-6 {
            margin-bottom: 1.5rem;
        }
        .ml-1 {
            margin-left: 0.25rem;
        }
        
        /* Background Colors */
        .bg-white {
            background-color: #ffffff;
        }
        .bg-gray-50 {
             background-color: #F9FAFB;
        }
        .bg-gray-500 {
            background-color: #6b7280;
        }
        .bg-sky-600 {
            background-color: #0284C7;
        }
        .bg-amber-500 {
            background-color: #F59E0B;
        }
        
        /* Text Colors */
        .text-white {
            color: #ffffff;
        }
        .text-gray-500 {
            color: #6b7280;
        }
        .text-gray-700 {
            color: #374151;
        }
        .text-gray-800 {
            color: #1f2937;
        }
        
        /* Border */
        .border {
            border-width: 1px;
        }
        .border-2 {
            border-width: 2px;
        }
        .border-t {
            border-top-width: 1px;
        }
        .border-gray-300 {
            border-color: #d1d5db;
        }
        .border-purple-300 {
            border-color: #d8b4fe;
        }
        .border-purple-500 {
            border-color: #a855f7;
        }
        .border-red-400 {
            border-color: #f87171;
        }
        .border-green-400 {
            border-color: #4ade80;
        }
        .border-transparent {
            border-color: transparent;
        }
        
        /* Border Radius */
        .rounded-lg {
            border-radius: 0.5rem;
        }
        .rounded-xl {
            border-radius: 0.75rem;
        }
        .rounded-full {
            border-radius: 9999px;
        }
        
        /* Shadow */
        .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .shadow-xl {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        /* Text */
        .text-xs {
            font-size: 0.75rem;
        }
        .text-sm {
            font-size: 0.875rem;
        }
        .text-lg {
            font-size: 1.125rem;
        }
        .text-xl {
            font-size: 1.25rem;
        }
        .text-2xl {
            font-size: 1.5rem;
        }
        .text-3xl {
            font-size: 1.875rem;
        }
        .font-medium {
            font-weight: 500;
        }
        .font-semibold {
            font-weight: 600;
        }
        .font-bold {
            font-weight: 700;
        }
        .text-center {
            text-align: center;
        }
        .underline {
            text-decoration: underline;
        }
        
        /* Display */
        .overflow-y-auto {
            overflow-y: auto;
        }
        
        /* Position */
        .fixed {
            position: fixed;
        }
        .inset-0 {
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }
        
        /* Z-Index */
        .z-50 {
            z-index: 50;
        }
        
        /* Opacity */
        .bg-opacity-50 {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .bg-opacity-20 {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .bg-opacity-30 {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        /* Transition */
        button, input {
            transition: all 0.2s ease;
        }
        
        /* Custom Styles */
        #apiKeyModal {
            background-color: rgba(0, 0, 0, 0.5);
        }
        strong {
            font-weight: 600;
        }
        em {
            font-style: italic;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        .card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        .hidden {
            display: none !important;
        }
        #deckScreen {
            padding-bottom: 80px; /* Space for the fixed action bar */
        }
        #collectionScreen {
            padding-bottom: 80px; /* Space for the fixed action bar */
        }
        #collectionActions {
            transition: transform 0.3s ease;
        }
        #collectionActions:has(button:disabled) {
            transform: translateY(200%);
        }
        #workbenchScreen {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        #workbenchInput {
            position: sticky;
            bottom: 0;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- API Key Modal -->
    <div id="apiKeyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">
            <h2 class="text-xl font-bold text-gray-800 mb-4">üîë API Key Required</h2>
            <p class="text-gray-700 mb-4">
                To use Idea Foundry, you need a Gemini API key. 
                <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-sky-600 underline">
                    Get one here
                </a>
            </p>
            <input 
                type="text" 
                id="apiKeyInput" 
                placeholder="Enter your Gemini API key" 
                class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-2"
            />
            <div id="apiKeyError" class="text-red-600 text-sm mb-2 hidden">Please enter a valid API key</div>
            <button 
                id="saveApiKeyBtn"
                class="w-full px-6 py-3 bg-sky-600 text-white rounded-lg font-medium"
            >
                Save and Start
            </button>
        </div>
    </div>

    <div class="container mx-auto max-w-6xl p-4 min-h-screen flex flex-col">
        <!-- Header -->
        <div class="bg-white text-gray-700 p-4 rounded-lg shadow-md mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold">üí° Idea Foundry</h1>
                </div>
                <div class="flex space-x-2">
                    <button id="navDeck" class="px-4 py-2 rounded-lg font-medium">
                        The Deck
                    </button>
                    <button id="navCollection" class="px-4 py-2 rounded-lg font-medium">
                        Collection <span id="collectionCount" class="bg-sky-600 text-white px-2 py-1 rounded-full text-xs ml-1">0</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- The Deck Screen -->
        <div id="deckScreen" class="flex-1 flex flex-col justify-center items-center">
            <div id="currentCard" class="bg-white rounded-xl shadow-md p-6 mb-6 card w-full max-w-2xl flex-1">
                <div id="cardContent">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Welcome to Idea Foundry</h2>
                    <p class="text-gray-700 mb-4">
                        Click the "Next Idea" button to discover AI-generated ideas. Pin the ones you like to your collection!
                    </p>
                </div>
            </div>
            <div id="deckActions" class="fixed bottom-0 left-0 right-0 bg-white p-4 shadow-md">
                <div class="flex space-x-4 max-w-2xl mx-auto">
                    <button id="nextCardBtn" class="flex-1 px-6 py-3 bg-sky-600 text-white rounded-lg font-medium text-lg" style="min-height: 44px;">
                        Next Idea
                    </button>
                    <button id="pinCardBtn" class="flex-1 px-6 py-3 bg-amber-500 text-white rounded-lg font-medium text-lg" style="min-height: 44px;" disabled>
                        üìå Pin
                    </button>
                </div>
            </div>
        </div>

        <!-- The Collection Screen -->
        <div id="collectionScreen" class="flex-1 hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div id="collectionGrid" class="grid grid-cols-1 gap-4">
                    <div class="text-center text-gray-500 py-12">
                        No pinned ideas yet. Go to The Deck to discover and pin ideas!
                    </div>
                </div>
            </div>
            <div id="collectionActions" class="fixed bottom-0 left-0 right-0 p-4">
                <div class="max-w-2xl mx-auto">
                    <button id="brainstormBtn" class="w-full px-6 py-3 bg-sky-600 text-white rounded-lg font-medium text-lg shadow-lg" style="min-height: 44px;" disabled>
                        üí≠ Brainstorm with Selected
                    </button>
                </div>
            </div>
        </div>

        <!-- The Workbench Screen -->
        <div id="workbenchScreen" class="flex-1 hidden flex-col bg-white shadow-md rounded-lg">
            <div id="workbenchHeader" class="p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-800 text-center">Brainstorming</h2>
                <div id="contextCards" class="text-xs text-gray-500 text-center truncate"></div>
            </div>
            <div id="chatMessages" class="flex-1 p-6 overflow-y-auto space-y-4">
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0 w-8 h-8 bg-sky-600 rounded-full flex items-center justify-center text-white font-bold text-sm">
                        AI
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 max-w-3xl">
                        <p class="text-gray-700">
                            Let's brainstorm together! I've reviewed the ideas you selected. What would you like to explore or develop?
                        </p>
                    </div>
                </div>
            </div>
            <div id="workbenchInput" class="border-t p-4 bg-white">
                <form id="chatForm" class="flex space-x-3 mb-2">
                    <input type="text" id="userInput" placeholder="Discuss your ideas with AI..." class="flex-1 px-4 py-3 border border-gray-300 rounded-lg" required style="min-height: 44px;">
                    <button type="submit" id="sendBtn" class="px-6 py-3 bg-sky-600 text-white rounded-lg font-medium" style="min-height: 44px;">
                        Send
                    </button>
                </form>
                <div class="flex space-x-2">
                    <button id="saveNewIdeaBtn" class="flex-1 px-4 py-2 bg-amber-500 text-white rounded-lg font-medium" style="min-height: 44px;">
                        üíæ Save as New Idea
                    </button>
                    <button id="exitWorkbenchBtn" class="px-4 py-2 bg-gray-500 text-white rounded-lg" style="min-height: 44px;">
                        ‚Üê Back to Collection
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import TOON library from local file
        import { encode, decode } from './toon-lib.js';

        // Configuration
        const GEMINI_API_ENDPOINT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent';
        
        // State
        let apiKey = localStorage.getItem('gemini_api_key') || '';
        let currentCard = null;
        let pinnedCards = JSON.parse(localStorage.getItem('pinned_cards') || '[]');
        let selectedCardIds = new Set();
        let conversationHistory = [];
        let contextCards = [];
        
        // DOM Elements
        const apiKeyModal = document.getElementById('apiKeyModal');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
        const apiKeyError = document.getElementById('apiKeyError');
        
        const navDeck = document.getElementById('navDeck');
        const navCollection = document.getElementById('navCollection');
        const collectionCount = document.getElementById('collectionCount');
        
        const deckScreen = document.getElementById('deckScreen');
        const collectionScreen = document.getElementById('collectionScreen');
        const workbenchScreen = document.getElementById('workbenchScreen');
        
        const cardContent = document.getElementById('cardContent');
        const nextCardBtn = document.getElementById('nextCardBtn');
        const pinCardBtn = document.getElementById('pinCardBtn');
        
        const collectionGrid = document.getElementById('collectionGrid');
        const brainstormBtn = document.getElementById('brainstormBtn');
        
        const chatMessages = document.getElementById('chatMessages');
        const chatForm = document.getElementById('chatForm');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const saveNewIdeaBtn = document.getElementById('saveNewIdeaBtn');
        const exitWorkbenchBtn = document.getElementById('exitWorkbenchBtn');
        const contextCardsDiv = document.getElementById('contextCards');

        // Initialize
        if (apiKey) {
            apiKeyModal.style.display = 'none';
        }
        updateCollectionCount();

        // API Key handling
        saveApiKeyBtn.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            if (key) {
                apiKey = key;
                localStorage.setItem('gemini_api_key', key);
                apiKeyModal.style.display = 'none';
                apiKeyError.classList.add('hidden');
            } else {
                apiKeyError.classList.remove('hidden');
            }
        });

        // Navigation
        navDeck.addEventListener('click', () => showScreen('deck'));
        navCollection.addEventListener('click', () => showScreen('collection'));
        exitWorkbenchBtn.addEventListener('click', () => showScreen('collection'));

        function showScreen(screen) {
            deckScreen.classList.add('hidden');
            collectionScreen.classList.add('hidden');
            workbenchScreen.classList.add('hidden');
            
            if (screen === 'deck') {
                deckScreen.classList.remove('hidden');
            } else if (screen === 'collection') {
                collectionScreen.classList.remove('hidden');
                renderCollection();
            } else if (screen === 'workbench') {
                workbenchScreen.classList.remove('hidden');
            }
        }

        // The Deck - Next Card
        nextCardBtn.addEventListener('click', async () => {
            if (!apiKey) {
                apiKeyModal.style.display = 'flex';
                return;
            }

            nextCardBtn.disabled = true;
            pinCardBtn.disabled = true;
            
            try {
                const card = await generateNewIdea();
                currentCard = card;
                renderCurrentCard(card);
                pinCardBtn.disabled = false;
            } catch (error) {
                showError(error.message);
            } finally {
                nextCardBtn.disabled = false;
            }
        });

        // The Deck - Pin Card
        pinCardBtn.addEventListener('click', () => {
            if (currentCard) {
                pinnedCards.push(currentCard);
                localStorage.setItem('pinned_cards', JSON.stringify(pinnedCards));
                updateCollectionCount();
                showNotification('Idea pinned to collection! üìå');
                pinCardBtn.disabled = true;
            }
        });

        // The Collection - Brainstorm
        brainstormBtn.addEventListener('click', () => {
            if (selectedCardIds.size > 0) {
                contextCards = pinnedCards.filter(card => selectedCardIds.has(card.id));
                startBrainstormSession(contextCards);
            }
        });

        // The Workbench - Chat
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!apiKey) {
                apiKeyModal.style.display = 'flex';
                return;
            }

            const message = userInput.value.trim();
            if (!message) return;

            userInput.disabled = true;
            sendBtn.disabled = true;
            saveNewIdeaBtn.disabled = true;

            addChatMessage(message, 'user');
            userInput.value = '';

            const loadingId = addLoadingMessage();

            try {
                const response = await sendBrainstormMessage(message);
                removeMessage(loadingId);
                addChatMessage(response, 'ai');
            } catch (error) {
                removeMessage(loadingId);
                addChatMessage(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                userInput.disabled = false;
                sendBtn.disabled = false;
                saveNewIdeaBtn.disabled = false;
                userInput.focus();
            }
        });

        // The Workbench - Save New Idea
        saveNewIdeaBtn.addEventListener('click', async () => {
            if (!apiKey) {
                apiKeyModal.style.display = 'flex';
                return;
            }

            saveNewIdeaBtn.disabled = true;
            sendBtn.disabled = true;
            userInput.disabled = true;

            const loadingId = addLoadingMessage();

            try {
                const newCard = await saveNewIdea();
                removeMessage(loadingId);
                
                pinnedCards.push(newCard);
                localStorage.setItem('pinned_cards', JSON.stringify(pinnedCards));
                updateCollectionCount();
                
                addChatMessage(`‚úÖ Success! Your new idea "${newCard.title}" has been saved to your collection.`, 'success');
                
                setTimeout(() => {
                    showScreen('collection');
                }, 2000);
            } catch (error) {
                removeMessage(loadingId);
                addChatMessage(`‚ùå Error: ${error.message}`, 'error');
                saveNewIdeaBtn.disabled = false;
                sendBtn.disabled = false;
                userInput.disabled = false;
            }
        });

        // Generate New Idea (The Deck)
        async function generateNewIdea() {
            // Step 1: AI generates a high-level topic
            const topicPrompt = "Generate a high-level technical topic, like 'AI in developer tools' or 'Decentralized social media'.";
            const topic = await callGeminiAPI(topicPrompt, "Provide a single topic.");

            // Step 2: App fetches Hacker News sources
            const sources = await fetchHnSources(topic);
            if (sources.length < 3) {
                throw new Error("Could not fetch enough sources from Hacker News.");
            }

            // Step 3: AI synthesizes an idea from the sources
            const sourcesText = sources.map(s => `Title: ${s.title}\nURL: ${s.url}`).join('\n\n');
            const synthesisPrompt = `You are an idea synthesizer. Based only on the provided Hacker News articles, create a single, novel idea. Your response must be a TOON-formatted string. You must populate the sources field with the 3 articles provided as context. Use the header: cards[1]{id,title,summary,tags,source,sources}:`;
            
            const response = await callGeminiAPI(synthesisPrompt, `Here are the sources:\n${sourcesText}`);

            try {
                const decoded = decode(response);
                
                // Handle both array and object responses
                if (Array.isArray(decoded) && decoded.length > 0) {
                    return decoded[0];
                } else if (decoded && typeof decoded === 'object' && !Array.isArray(decoded)) {
                    return decoded;
                }
                
                throw new Error('Invalid card format received from AI');
            } catch (error) {
                console.error('Failed to decode TOON response:', response);
                throw new Error(`Failed to parse AI response: ${error.message}`);
            }
        }

        // Start Brainstorm Session (The Workbench)
        function startBrainstormSession(cards) {
            conversationHistory = [];
            contextCards = cards;
            
            // Reset chat
            chatMessages.innerHTML = '';
            
            // Display context cards
            const contextTitle = cards.map(c => `"${escapeHtml(c.title)}"`).join(' + ');
            contextCardsDiv.innerHTML = `On: ${contextTitle}`;
            
            // Add initial AI message
            const toonContext = encode(cards);
            const welcomeMessage = `Let's brainstorm together! I've reviewed your selected ideas:\n\n${cards.map(c => `‚Ä¢ ${c.title}: ${c.summary}`).join('\n')}\n\nWhat would you like to explore or develop?`;
            addChatMessage(welcomeMessage, 'ai');
            
            // Store context in conversation history
            conversationHistory.push({
                role: 'user',
                content: `Context (TOON format): ${toonContext}`
            });
            conversationHistory.push({
                role: 'assistant',
                content: welcomeMessage
            });
            
            showScreen('workbench');
        }

        // Send Brainstorm Message
        async function sendBrainstormMessage(message) {
            conversationHistory.push({ role: 'user', content: message });

            const toonContext = encode(contextCards);
            const systemPrompt = `You are an expert creative strategist. The user has provided these initial ideas in TOON format: ${toonContext}. Your goal is to help them synthesize these into a new concept. You can use the command [HN_SEARCH: {topic}] to search Hacker News for more context. Do not respond in TOON format during the discussion; use plain text.`;

            let response = await callGeminiAPI(systemPrompt, message, conversationHistory.slice(1));

            const hnSearchMatch = response.match(/\[HN_SEARCH:\s*(.*?)\]/);
            if (hnSearchMatch) {
                const topic = hnSearchMatch[1];
                addChatMessage(`Searching Hacker News for "${topic}"...`, 'ai');
                const sources = await fetchHnSources(topic);
                const sourcesText = sources.map(s => `Title: ${s.title}\nURL: ${s.url}`).join('\n\n');

                conversationHistory.push({ role: 'assistant', content: response });
                conversationHistory.push({ role: 'user', content: `Here are the Hacker News search results:\n${sourcesText}` });

                response = await callGeminiAPI(systemPrompt, `Here are the Hacker News search results:\n${sourcesText}`, conversationHistory.slice(1));
            }

            conversationHistory.push({ role: 'assistant', content: response });
            return response;
        }

        // Save New Idea from Brainstorm
        async function saveNewIdea() {
            const systemPrompt = `Now, respond only with a single TOON-formatted string for the new card we just developed. Use the header: cards[1]{id,title,summary,tags,source,sources}: and set the source to 'From Brainstorm'. The sources field should be an empty array.`;
            
            const message = 'Please summarize our entire discussion into a new, refined idea card. Set the source to "From Brainstorm".';
            
            const response = await callGeminiAPI(systemPrompt, message, conversationHistory);
            
            try {
                const decoded = decode(response);
                
                // Handle both array and object responses
                if (Array.isArray(decoded) && decoded.length > 0) {
                    return decoded[0];
                } else if (decoded && typeof decoded === 'object' && !Array.isArray(decoded)) {
                    return decoded;
                }
                
                throw new Error('Invalid card format received from AI');
            } catch (error) {
                console.error('Failed to decode TOON response:', response);
                throw new Error(`Failed to parse AI response: ${error.message}`);
            }
        }

        // Call Gemini API
        async function callGeminiAPI(systemPrompt, userMessage, history = []) {
            const contents = [
                {
                    role: 'user',
                    parts: [{ text: systemPrompt }]
                }
            ];
            
            // Add conversation history
            for (const msg of history) {
                contents.push({
                    role: msg.role === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.content }]
                });
            }
            
            // Add current message
            contents.push({
                role: 'user',
                parts: [{ text: userMessage }]
            });

            const response = await fetch(`${GEMINI_API_ENDPOINT}?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ contents })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || `API request failed with status ${response.status}`);
            }

            const data = await response.json();
            
            if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                throw new Error('Invalid response from Gemini API');
            }

            return data.candidates[0].content.parts[0].text;
        }

        async function fetchHnSources(topic, count = 3) {
            const response = await fetch(`https://hn.algolia.com/api/v1/search?query=${encodeURIComponent(topic)}&tags=story,comment`);
            if (!response.ok) {
                throw new Error('Failed to fetch from Hacker News API');
            }
            const data = await response.json();
            const sources = data.hits.map(hit => ({
                title: hit.title || hit.story_title,
                url: hit.url || `https://news.ycombinator.com/item?id=${hit.objectID}`
            })).filter(source => source.title && source.url);

            // Deduplicate and get the desired count
            const uniqueSources = Array.from(new Map(sources.map(s => [s.url, s])).values());
            return uniqueSources.slice(0, count);
        }

        // UI Functions
        function renderCurrentCard(card) {
            cardContent.innerHTML = `
                <h2 class="text-xl font-bold text-gray-800 mb-4">${escapeHtml(card.title)}</h2>
                <p class="text-gray-700 mb-4">${escapeHtml(card.summary)}</p>
                <div class="flex flex-wrap gap-2 mb-2">
                    ${card.tags ? card.tags.map(tag => 
                        `<span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm">${escapeHtml(tag)}</span>`
                    ).join('') : ''}
                </div>
                <div class="text-xs text-gray-500 mt-4">Source: ${escapeHtml(card.source || 'Unknown')}</div>
                ${card.sources && card.sources.length > 0 ? `
                    <div class="mt-4">
                        <h3 class="text-sm font-semibold text-gray-800 mb-2">Sources</h3>
                        <ul class="space-y-1">
                            ${card.sources.map(source => `
                                <li>
                                    <a href="${source.url}" target="_blank" class="text-sky-600 underline text-sm">${escapeHtml(source.title)}</a>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                ` : ''}
            `;
            cardContent.classList.add('fade-in');
        }

        function renderCollection() {
            if (pinnedCards.length === 0) {
                collectionGrid.innerHTML = `
                    <div class="text-center text-gray-500 py-12">
                        No pinned ideas yet. Go to The Deck to discover and pin ideas!
                    </div>
                `;
                return;
            }

            collectionGrid.innerHTML = pinnedCards.map(card => `
                <div class="card bg-white rounded-lg shadow-md p-4 cursor-pointer border-2 ${selectedCardIds.has(card.id) ? 'border-sky-500 bg-sky-50' : 'border-transparent'}"
                     data-card-id="${card.id}">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">${escapeHtml(card.title)}</h3>
                    <p class="text-gray-700 text-sm mb-3">${escapeHtml(card.summary)}</p>
                    <div class="flex flex-wrap gap-1 mb-2">
                        ${card.tags ? card.tags.slice(0, 3).map(tag =>
                            `<span class="px-2 py-1 bg-gray-100 text-gray-700 rounded-full text-xs">${escapeHtml(tag)}</span>`
                        ).join('') : ''}
                    </div>
                    <div class="text-xs text-gray-400">Source: ${escapeHtml(card.source || 'Unknown')}</div>
                    ${card.sources && card.sources.length > 0 ? `<div class="text-xs text-gray-400 mt-1">${card.sources.length} sources</div>` : ''}
                </div>
            `).join('');

            // Add click handlers
            document.querySelectorAll('[data-card-id]').forEach(cardEl => {
                cardEl.addEventListener('click', () => {
                    const cardId = cardEl.dataset.cardId;
                    if (selectedCardIds.has(cardId)) {
                        selectedCardIds.delete(cardId);
                        cardEl.classList.remove('border-sky-500', 'bg-sky-50');
                        cardEl.classList.add('border-transparent');
                    } else {
                        selectedCardIds.add(cardId);
                        cardEl.classList.add('border-sky-500', 'bg-sky-50');
                        cardEl.classList.remove('border-transparent');
                    }
                    brainstormBtn.disabled = selectedCardIds.size === 0;
                });
            });

            brainstormBtn.disabled = selectedCardIds.size === 0;
        }

        function addChatMessage(content, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start space-x-3 fade-in';
            messageDiv.dataset.messageId = Date.now();

            if (type === 'user') {
                messageDiv.classList.add('flex-row-reverse', 'space-x-reverse');
                messageDiv.innerHTML = `
                    <div class="flex-shrink-0 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm">
                        U
                    </div>
                    <div class="bg-blue-500 text-white rounded-lg p-4 max-w-3xl">
                        ${escapeHtml(content)}
                    </div>
                `;
            } else if (type === 'error') {
                messageDiv.innerHTML = `
                    <div class="flex-shrink-0 w-8 h-8 bg-red-500 rounded-full flex items-center justify-center text-white font-bold text-sm">
                        !
                    </div>
                    <div class="bg-red-100 border border-red-400 text-red-700 rounded-lg p-4 max-w-3xl">
                        ${escapeHtml(content)}
                    </div>
                `;
            } else if (type === 'success') {
                messageDiv.innerHTML = `
                    <div class="flex-shrink-0 w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white font-bold text-sm">
                        ‚úì
                    </div>
                    <div class="bg-green-100 border border-green-400 text-green-700 rounded-lg p-4 max-w-3xl">
                        ${escapeHtml(content)}
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="flex-shrink-0 w-8 h-8 bg-sky-600 rounded-full flex items-center justify-center text-white font-bold text-sm">
                        AI
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 max-w-3xl">
                        ${formatResponse(content)}
                    </div>
                `;
            }

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageDiv.dataset.messageId;
        }

        function addLoadingMessage() {
            const loadingDiv = document.createElement('div');
            const loadingId = 'loading-' + Date.now();
            loadingDiv.dataset.messageId = loadingId;
            loadingDiv.className = 'flex items-start space-x-3';
            loadingDiv.innerHTML = `
                <div class="flex-shrink-0 w-8 h-8 bg-sky-600 rounded-full flex items-center justify-center text-white font-bold text-sm">
                    AI
                </div>
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-5 h-5 border-2 border-sky-600 border-t-transparent rounded-full animate-spin"></div>
                        <span class="text-gray-700">Thinking...</span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return loadingId;
        }

        function removeMessage(messageId) {
            const message = chatMessages.querySelector(`[data-message-id="${messageId}"]`);
            if (message) {
                message.remove();
            }
        }

        function updateCollectionCount() {
            collectionCount.textContent = pinnedCards.length;
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function showError(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in';
            notification.textContent = '‚ùå ' + message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }

        function formatResponse(text) {
            text = escapeHtml(text);
            text = text.replace(/\*\*([^\*]+)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*([^\*<>]+)\*/g, (match, content) => {
                if (content.includes('<strong>') || content.includes('</strong>')) {
                    return match;
                }
                return '<em>' + content + '</em>';
            });
            text = text.replace(/\n/g, '<br>');
            text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-sky-600 underline">$1</a>');
            return text;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
